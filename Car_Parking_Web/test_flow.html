<!DOCTYPE html>
<html>
<head>
    <title>Test Parking Flow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>üÖøÔ∏è Test Parking System Flow</h2>
        
        <!-- Current Status -->
        <div class="card mb-4">
            <div class="card-header">üìä Tr·∫°ng th√°i hi·ªán t·∫°i</div>
            <div class="card-body">
                <div id="current-status">ƒêang t·∫£i...</div>
                <button class="btn btn-info btn-sm" onclick="loadCurrentStatus()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Step 1: ƒê·∫∑t ch·ªó -->
        <div class="card mb-4">
            <div class="card-header">üéØ B∆∞·ªõc 1: ƒê·∫∑t ch·ªó ƒë·ªó xe</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label>Ch·ªçn √¥ ƒë·ªó:</label>
                        <select class="form-control" id="reserve-spot">
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                            <option value="P5">P5</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Bi·ªÉn s·ªë xe:</label>
                        <input type="text" class="form-control" id="reserve-license" value="29A-1234">
                    </div>
                    <div class="col-md-4">
                        <label>&nbsp;</label><br>
                        <button class="btn btn-primary" onclick="makeReservation()">üìù ƒê·∫∑t ch·ªó</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Gi·∫£ l·∫≠p xe v√†o -->
        <div class="card mb-4">
            <div class="card-header">üöó B∆∞·ªõc 2: Gi·∫£ l·∫≠p xe v√†o b√£i (MQTT simulation)</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label>√î ƒë·ªó xe v√†o:</label>
                        <select class="form-control" id="enter-spot">
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                            <option value="P5">P5</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Bi·ªÉn s·ªë ph√°t hi·ªán:</label>
                        <input type="text" class="form-control" id="detected-license" value="29A-1234">
                    </div>
                    <div class="col-md-4">
                        <label>&nbsp;</label><br>
                        <button class="btn btn-success" onclick="simulateCarEnter()">üöó Xe v√†o b√£i</button>
                    </div>
                </div>
                <small class="text-muted">üí° Tip: S·ª≠ d·ª•ng c√πng bi·ªÉn s·ªë v·ªõi ƒë·∫∑t ch·ªó ƒë·ªÉ h·ªá th·ªëng x√°c nh·∫≠n t·ª± ƒë·ªông</small>
            </div>
        </div>

        <!-- Step 3: License Plate Detection -->
        <div class="card mb-4">
            <div class="card-header">üì∑ B∆∞·ªõc 3: Gi·∫£ l·∫≠p ph√°t hi·ªán bi·ªÉn s·ªë (Camera simulation)</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label>Bi·ªÉn s·ªë ph√°t hi·ªán t·ª´ camera:</label>
                        <input type="text" class="form-control" id="camera-license" value="29A-1234">
                    </div>
                    <div class="col-md-6">
                        <label>&nbsp;</label><br>
                        <button class="btn btn-warning" onclick="simulateLicenseDetection()">üì∑ Ph√°t hi·ªán bi·ªÉn s·ªë</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Car Exit -->
        <div class="card mb-4">
            <div class="card-header">üö™ B∆∞·ªõc 4: Xe r·ªùi b√£i</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label>√î ƒë·ªó xe r·ªùi:</label>
                        <select class="form-control" id="exit-spot">
                            <option value="P1">P1</option>
                            <option value="P2">P2</option>
                            <option value="P3">P3</option>
                            <option value="P4">P4</option>
                            <option value="P5">P5</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>&nbsp;</label><br>
                        <button class="btn btn-danger" onclick="simulateCarExit()">üö™ Xe r·ªùi b√£i</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card">
            <div class="card-header">üìã Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</div>
            <div class="card-body">
                <div id="activity-log" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <small class="text-muted">Ch·ªù ho·∫°t ƒë·ªông...</small>
                </div>
                <button class="btn btn-secondary btn-sm mt-2" onclick="clearLog()">üóëÔ∏è X√≥a log</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;

        // K·∫øt n·ªëi Socket.IO
        document.addEventListener('DOMContentLoaded', function() {
            connectSocket();
            loadCurrentStatus();
        });

        function connectSocket() {
            socket = io('http://localhost:5000');
            
            socket.on('connect', function() {
                logActivity('‚úÖ K·∫øt n·ªëi server th√†nh c√¥ng', 'success');
            });
            
            socket.on('disconnect', function() {
                logActivity('‚ùå M·∫•t k·∫øt n·ªëi server', 'danger');
            });
            
            socket.on('reservation_made', function(data) {
                logActivity(`üìù ƒê·∫∑t ch·ªó th√†nh c√¥ng: ${data.spot_id} cho xe ${data.license_plate}`, 'primary');
                loadCurrentStatus();
            });
            
            socket.on('spot_status_update', function(data) {
                logActivity(`üîÑ C·∫≠p nh·∫≠t ${data.spot_id}: ${data.status}`, 'info');
                loadCurrentStatus();
            });
            
            socket.on('license_plate_detected', function(data) {
                logActivity(`üì∑ Ph√°t hi·ªán bi·ªÉn s·ªë: ${data.license_plate}`, 'warning');
            });
        }

        // ƒê·∫∑t ch·ªó
        function makeReservation() {
            const spotId = document.getElementById('reserve-spot').value;
            const licensePlate = document.getElementById('reserve-license').value;
            
            fetch('http://localhost:5000/api/reserve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    spot_id: spotId, 
                    license_plate: licensePlate,
                    user_id: 1 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logActivity(`‚úÖ ${data.message}`, 'success');
                } else {
                    logActivity(`‚ùå L·ªói: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                logActivity(`‚ùå Network Error: ${error}`, 'danger');
            });
        }

        // Gi·∫£ l·∫≠p xe v√†o
        function simulateCarEnter() {
            const spotId = document.getElementById('enter-spot').value;
            const licensePlate = document.getElementById('detected-license').value;
            
            fetch('http://localhost:5000/api/demo/car-enter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    spot_id: spotId, 
                    license_plate: licensePlate 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logActivity(`üöó ${data.message}`, 'success');
                } else {
                    logActivity(`‚ùå L·ªói: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                logActivity(`‚ùå Network Error: ${error}`, 'danger');
            });
        }

        // Gi·∫£ l·∫≠p ph√°t hi·ªán bi·ªÉn s·ªë
        function simulateLicenseDetection() {
            const licensePlate = document.getElementById('camera-license').value;
            
            // Emit qua Socket.IO ƒë·ªÉ gi·∫£ l·∫≠p MQTT message
            socket.emit('simulate_license_detection', {
                license_plate: licensePlate
            });
            
            logActivity(`üì∑ Gi·∫£ l·∫≠p camera ph√°t hi·ªán: ${licensePlate}`, 'warning');
        }

        // Xe r·ªùi b√£i
        function simulateCarExit() {
            const spotId = document.getElementById('exit-spot').value;
            
            fetch('http://localhost:5000/api/demo/car-exit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spot_id: spotId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logActivity(`üö™ ${data.message}`, 'success');
                } else {
                    logActivity(`‚ùå L·ªói: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                logActivity(`‚ùå Network Error: ${error}`, 'danger');
            });
        }

        // Load tr·∫°ng th√°i hi·ªán t·∫°i
        function loadCurrentStatus() {
            fetch('http://localhost:5000/api/spots')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = '<div class="row">';
                    data.spots.forEach(spot => {
                        const statusColor = {
                            'empty': 'success',
                            'reserved': 'warning', 
                            'occupied': 'danger'
                        }[spot.status] || 'secondary';
                        
                        html += `
                            <div class="col-md-2 mb-2">
                                <div class="card border-${statusColor}">
                                    <div class="card-body p-2 text-center">
                                        <h6 class="card-title">${spot.spot_id}</h6>
                                        <span class="badge bg-${statusColor}">${spot.status}</span>
                                        ${spot.license_plate ? `<br><small>${spot.license_plate}</small>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('current-status').innerHTML = html;
                }
            })
            .catch(error => {
                document.getElementById('current-status').innerHTML = `<span class="text-danger">L·ªói: ${error}</span>`;
            });
        }

        // Log activity
        function logActivity(message, type = 'info') {
            const log = document.getElementById('activity-log');
            const time = new Date().toLocaleTimeString();
            const colorClass = {
                'success': 'text-success',
                'danger': 'text-danger', 
                'warning': 'text-warning',
                'info': 'text-info',
                'primary': 'text-primary'
            }[type] || 'text-dark';
            
            log.innerHTML += `<div class="${colorClass}"><small>[${time}]</small> ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // Clear log
        function clearLog() {
            document.getElementById('activity-log').innerHTML = '<small class="text-muted">Log ƒë√£ ƒë∆∞·ª£c x√≥a...</small>';
        }
    </script>
</body>
</html>